{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard | UCC Library</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-green: #0B3D2E;
            --light-bg: #f8f9fa;
            --text-dark: #343a40;
            --card-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        body {
            background-color: var(--light-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-dark);
            overflow-x: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            background-color: #0B3D2E;
            height: 100vh; color: white; box-shadow: 4px 0 10px rgba(0,0,0,0.1);
            position: fixed; top: 0; bottom: 0; left: 0; z-index: 100;
            width: 250px; overflow-y: auto; display: flex; flex-direction: column;
        }
        .sidebar::-webkit-scrollbar { width: 6px; }
        .sidebar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
        .nav-link {
            color: rgba(255,255,255,0.85); margin-bottom: 8px; padding: 12px 15px; border-radius: 8px;
            transition: all 0.3s ease; font-size: 0.95rem; white-space: nowrap;
        }
        .nav-link:hover { color: white; background: rgba(255,255,255,0.15); transform: translateX(5px); }
        .nav-link.active { background-color: white; color: #0B3D2E; font-weight: 700; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .sidebar-logo { max-width: 80px; margin-bottom: 15px; border: 3px solid rgba(255,255,255,0.2); border-radius: 50%; padding: 5px; }

        /* MAIN CONTENT */
        .main-content { margin-left: 250px; padding: 50px 30px 30px 30px; width: calc(100% - 250px); }

        @media (max-width: 768px) {
            .sidebar { width: 80px; align-items: center; }
            .sidebar .nav-link span, .sidebar .sidebar-heading { display: none; }
            .sidebar-logo { width: 40px; }
            .main-content { margin-left: 80px; width: calc(100% - 80px); }
        }

        /* CARDS */
        .stat-card { border: none; border-radius: 20px; background: white; box-shadow: var(--card-shadow); transition: transform 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); }
        .icon-box { width: 60px; height: 60px; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 1.75rem; }

        .content-card { background: white; border-radius: 20px; border: none; box-shadow: var(--card-shadow); height: 100%; display: flex; flex-direction: column; overflow: hidden; }
        .card-header-custom { padding: 20px 25px; border-bottom: 1px solid #eee; background: white; }
        .section-title { font-size: 1.1rem; font-weight: 700; color: var(--primary-green); margin: 0; text-transform: uppercase; }

        /* TABLES */
        .table thead th { background: #f8f9fa; color: #6c757d; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; padding: 12px 15px; border: none; }
        .table tbody td { padding: 10px 15px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; font-size: 0.9rem; }
        .badge-custom { padding: 5px 10px; border-radius: 50px; font-weight: 600; font-size: 0.7rem; }

        /* PREVENT TEXT WRAPPING */
        .no-wrap-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .compact-col { width: 1%; white-space: nowrap; } /* Forces column to be as small as content */

        /* PAGINATION COLORS */
        .pagination .page-link {
            color: var(--primary-green);
        }
        .pagination .page-link:hover {
            background-color: #e9ecef;
            color: #082e23;
        }
        .pagination .page-item.active .page-link {
            background-color: var(--primary-green);
            border-color: var(--primary-green);
            color: white;
        }
        .pagination-input {
            border-color: #dee2e6;
            color: var(--primary-green);
        }
        .pagination-input:focus {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 0.25rem rgba(11, 61, 46, 0.25);
        }
    </style>
</head>
<body>

<div class="container-fluid p-0">

    <div class="sidebar p-3">
        <div class="text-center mb-4 mt-2">
            <img src="{% static 'ucc_logo.png' %}" alt="Logo" class="sidebar-logo">
            <h5 class="fw-bold m-0 sidebar-heading" style="font-size: 1rem; letter-spacing: 1px;">UCC LIBRARY</h5>
            <small class="text-white-50">Attendance System</small>
        </div>

        <nav class="nav flex-column flex-grow-1">
            <div class="text-white-50 text-uppercase px-3 small fw-bold mb-2 sidebar-heading" style="font-size: 0.75rem;">Core Menu</div>
            <a class="nav-link" href="{% url 'dashboard' %}"><i class="fas fa-chart-pie me-3"></i> <span>Dashboard</span></a>
            <a class="nav-link" href="{% url 'landing_page' %}"><i class="fas fa-qrcode me-3"></i> <span>Scanner Mode</span></a>
            <a class="nav-link" href="{% url 'manual_checkin' %}"><i class="fas fa-keyboard me-3"></i> <span>Manual Entry</span></a>

            <div class="text-white-50 text-uppercase px-3 small fw-bold mt-4 mb-2 sidebar-heading" style="font-size: 0.75rem;">Management</div>
            <a class="nav-link active" href="{% url 'patron_list' %}"><i class="fas fa-users me-3"></i> <span>User List</span></a>
            <a class="nav-link" href="{% url 'add_patron' %}"><i class="fas fa-user-plus me-3"></i> <span>Register User</span></a>
            <a class="nav-link" href="{% url 'bulk_import' %}"><i class="fas fa-file-csv me-3"></i> <span>Bulk Import</span></a>

            <div class="text-white-50 text-uppercase px-3 small fw-bold mt-4 mb-2 sidebar-heading" style="font-size: 0.75rem;">Reports</div>
            <a class="nav-link" href="{% url 'report_selection' %}"><i class="fas fa-file-alt me-3"></i> <span>Print Reports</span></a>
            <a class="nav-link" href="{% url 'scan_history' %}"><i class="fas fa-history me-3"></i> <span>History Logs</span></a>
        </nav>

        <div class="mt-4 pb-4 border-top border-secondary pt-3">
            <a class="nav-link text-danger fw-bold" href="{% url 'logout' %}"><i class="fas fa-sign-out-alt me-3"></i> <span>Logout</span></a>
            <div class="text-center mt-3">
                <small class="text-white-50 d-block" style="font-size: 0.65rem; letter-spacing: 1px; opacity: 0.7;">CREATED BY JESICS</small>
                <small class="text-white-50 d-block" style="font-size: 0.65rem; letter-spacing: 1px; opacity: 0.7;">ALL RIGHTS RESERVED 2026</small>
            </div>
        </div>
    </div>

    <div class="main-content">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show shadow-sm rounded-4 mb-4" role="alert">
                    <i class="fas fa-info-circle me-2"></i> <strong>{{ message }}</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}

        <h2 class="fw-bold text-dark mb-4">Registered Users List</h2>

        <div class="card p-4 mb-4 border-0 shadow-sm rounded-4">
            <form method="get" class="row g-3">
                    <div class="col-md-2">
                        <label class="form-label small fw-bold text-muted">Search</label>
                        <input type="text" name="q" class="form-control" placeholder="Name or ID..." value="{{ request.GET.q }}">
                    </div>

                    <div class="col-md-2">
                        <label class="form-label small fw-bold text-muted">Role</label>
                        <select name="role" class="form-select">
                            <option value="">All Roles</option>
                            {% for code, name in roles %}
                                <option value="{{ code }}" {% if request.GET.role == code %}selected{% endif %}>{{ name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label small fw-bold text-muted">Department</label>
                        <select name="department" id="deptSelect" class="form-select" onchange="updatePrograms()">
                            <option value="">All Departments</option>
                            {% for code, name in departments %}
                                <option value="{{ code }}" {% if request.GET.department == code %}selected{% endif %}>{{ name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label small fw-bold text-muted">Year Level</label>
                        <select name="year_level" id="yearLevelSelect" class="form-select" onchange="checkBESFilter()">
                            <option value="">All Levels</option>
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label small fw-bold text-muted">Program</label>
                        <select name="program" id="programSelect" class="form-select">
                            <option value="">All Programs</option>
                        </select>
                    </div>

                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100 fw-bold" style="background-color: var(--primary-green); border: none;">
                            <i class="fas fa-filter me-2"></i> Apply
                        </button>
                    </div>
                </form>
        </div>

        <div class="card shadow-sm border-0 rounded-4">
            <div class="card-body p-0">
                <!-- Top Pagination Controls (New Minimalistic Design) -->
                {% if patrons.has_other_pages %}
                <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                    <div>
                        <small class="text-muted">
                             Page {{ patrons.number }} out of {{ patrons.paginator.num_pages }}
                        </small>
                    </div>
                    <nav aria-label="Page navigation">
                        <ul class="pagination pagination-sm mb-0">
                            <!-- First & Previous -->
                            {% if patrons.has_previous %}
                                <li class="page-item"><a class="page-link" href="?page=1&{{ query_params }}" title="First"><i class="fas fa-angle-double-left"></i></a></li>
                                <li class="page-item"><a class="page-link" href="?page={{ patrons.previous_page_number }}&{{ query_params }}" title="Previous"><i class="fas fa-angle-left"></i></a></li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link"><i class="fas fa-angle-double-left"></i></span></li>
                                <li class="page-item disabled"><span class="page-link"><i class="fas fa-angle-left"></i></span></li>
                            {% endif %}

                            <!-- Page Numbers -->
                            {% for i in patrons.paginator.get_elided_page_range %}
                                {% if i == patrons.paginator.ELLIPSIS %}
                                    <li class="page-item disabled"><span class="page-link">...</span></li>
                                {% else %}
                                    <li class="page-item {% if patrons.number == i %}active{% endif %}"><a class="page-link" href="?page={{ i }}&{{ query_params }}">{{ i }}</a></li>
                                {% endif %}
                            {% endfor %}

                            <!-- Next & Last -->
                            {% if patrons.has_next %}
                                <li class="page-item"><a class="page-link" href="?page={{ patrons.next_page_number }}&{{ query_params }}" title="Next"><i class="fas fa-angle-right"></i></a></li>
                                <li class="page-item"><a class="page-link" href="?page={{ patrons.paginator.num_pages }}&{{ query_params }}" title="Last"><i class="fas fa-angle-double-right"></i></a></li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link"><i class="fas fa-angle-right"></i></span></li>
                                <li class="page-item disabled"><span class="page-link"><i class="fas fa-angle-double-right"></i></span></li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}

                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th class="p-3">ID Number</th>
                                <th>Name</th>
                                <th>Role</th>
                                <th>Department</th>
                                <th>Year Level</th> <th>Last Time In</th>
                                <th>Last Time Out</th>
                                <th class="text-center p-3">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for patron in patrons %}
                            <tr>
                                <td class="p-3 fw-bold text-nowrap">{{ patron.id_number }}</td>
                                <td>
                                    {{ patron.first_name }} {% if patron.middle_name %}{{ patron.middle_name|slice:":1" }}.{% endif %} {{ patron.last_name }}
                                    {% if patron.department == 'BES' %}
                                        {% if patron.major %}
                                            <br><small class="text-muted">{{ patron.major|cut:"Academic Track: " }}</small>
                                        {% endif %}
                                    {% else %}
                                        {% if patron.program %}
                                            <br><small class="text-muted">{{ patron.program }}</small>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td><span class="badge bg-secondary rounded-pill">{{ patron.get_role_display }}</span></td>

                                <td>{{ patron.get_department_display|default:"-" }}</td>

                                <td class="text-nowrap">
                                    {% if patron.department == 'BES' %}
                                        {{ patron.program|default:"-" }}
                                    {% else %}
                                        {{ patron.year_level|default:"-" }}
                                    {% endif %}
                                </td>

                                {% with last_log=patron.logs.all.0 %}
                                <td>
                                    {% if last_log %}
                                        {{ last_log.scan_time|date:"h:i A" }}
                                        <div class="small text-muted">{{ last_log.scan_time|date:"M d" }}</div>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if last_log %}
                                        {% if last_log.time_out %}
                                            {{ last_log.time_out|date:"h:i A" }}
                                            <div class="small text-muted">{{ last_log.time_out|date:"M d" }}</div>
                                        {% else %}
                                            <span class="badge bg-success rounded-pill px-3 py-2">Active</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                {% endwith %}

                                <td class="text-center p-3">
                                    <div class="d-flex justify-content-center gap-2">
                                        <a href="{% url 'patron_detail' patron.id_number %}" class="btn btn-sm btn-outline-dark rounded-pill px-3" title="View QR Code">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="javascript:void(0);" onclick="confirmResend('{{ patron.id_number }}', '{{ patron.email|default_if_none:""|escapejs }}')" class="btn btn-sm btn-outline-warning rounded-pill px-3" title="Resend QR Email">
                                            <i class="fas fa-envelope"></i>
                                        </a>
                                        <button type="button"
                                            class="btn btn-sm btn-outline-primary rounded-pill px-3"
                                            data-id="{{ patron.id_number }}"
                                            data-firstname="{{ patron.first_name }}"
                                            data-middlename="{{ patron.middle_name }}"
                                            data-lastname="{{ patron.last_name }}"
                                            data-email="{{ patron.email|default:'' }}"
                                            data-program="{{ patron.program|default:'' }}"
                                            data-role="{{ patron.role }}"
                                            data-department="{{ patron.department }}"
                                            data-yearlevel="{{ patron.year_level|default:'' }}"
                                            data-major="{{ patron.major|default:'' }}"
                                            onclick="openEditModal(this)"
                                            title="Edit">
                                            <i class="fas fa-pen"></i>
                                        </button>
                                        <button type="button"
                                            class="btn btn-sm btn-outline-danger rounded-pill px-3"
                                            onclick="confirmDelete('{{ patron.id_number }}')"
                                            title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="8" class="text-center py-5 text-muted">No users found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Controls -->
                {% if patrons.has_other_pages %}
                <div class="d-flex justify-content-between align-items-center p-3 border-top">
                    <div>
                        <small class="text-muted">
                             Page {{ patrons.number }} out of {{ patrons.paginator.num_pages }}
                        </small>
                    </div>
                    <nav aria-label="Page navigation">
                        <ul class="pagination pagination-sm mb-0">
                            <!-- First & Previous -->
                            {% if patrons.has_previous %}
                                <li class="page-item"><a class="page-link" href="?page=1&{{ query_params }}" title="First"><i class="fas fa-angle-double-left"></i></a></li>
                                <li class="page-item"><a class="page-link" href="?page={{ patrons.previous_page_number }}&{{ query_params }}" title="Previous"><i class="fas fa-angle-left"></i></a></li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link"><i class="fas fa-angle-double-left"></i></span></li>
                                <li class="page-item disabled"><span class="page-link"><i class="fas fa-angle-left"></i></span></li>
                            {% endif %}

                            <!-- Page Numbers -->
                            {% for i in patrons.paginator.get_elided_page_range %}
                                {% if i == patrons.paginator.ELLIPSIS %}
                                    <li class="page-item disabled"><span class="page-link">...</span></li>
                                {% else %}
                                    <li class="page-item {% if patrons.number == i %}active{% endif %}"><a class="page-link" href="?page={{ i }}&{{ query_params }}">{{ i }}</a></li>
                                {% endif %}
                            {% endfor %}

                            <!-- Next & Last -->
                            {% if patrons.has_next %}
                                <li class="page-item"><a class="page-link" href="?page={{ patrons.next_page_number }}&{{ query_params }}" title="Next"><i class="fas fa-angle-right"></i></a></li>
                                <li class="page-item"><a class="page-link" href="?page={{ patrons.paginator.num_pages }}&{{ query_params }}" title="Last"><i class="fas fa-angle-double-right"></i></a></li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link"><i class="fas fa-angle-right"></i></span></li>
                                <li class="page-item disabled"><span class="page-link"><i class="fas fa-angle-double-right"></i></span></li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="editPatronModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content rounded-4 border-0 shadow">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold">Edit User Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">

                <form id="editForm" method="post" action="">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">ID Number</label>
                        <input type="text" class="form-control" id="modal_id_number" name="id_number" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">Email Address</label>
                        <input type="email" class="form-control" id="modal_email" name="email" placeholder="user@example.com">
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">Role</label>
                        <select class="form-select" id="modal_role" name="role" onchange="toggleModalRole()">
                            <option value="student">Student</option>
                            <option value="faculty">Faculty</option>
                            <option value="guest">Guest</option>
                        </select>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-md-4">
                            <label class="form-label text-muted small fw-bold">First Name</label>
                            <input type="text" class="form-control" id="modal_first_name" name="first_name">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-muted small fw-bold">Middle Name</label>
                            <input type="text" class="form-control" id="modal_middle_name" name="middle_name">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-muted small fw-bold">Last Name</label>
                            <input type="text" class="form-control" id="modal_last_name" name="last_name">
                        </div>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-md-4" id="modal_dept_col">
                            <label class="form-label text-muted small fw-bold">Department</label>
                            <select class="form-select" id="modal_department" name="department" onchange="updateModalPrograms()">
                                <option value="">Select Department</option>
                                {% for code, name in departments %}
                                    <option value="{{ code }}">{{ name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4" id="modal_year_level_container">
                            <label class="form-label text-muted small fw-bold">Year Level</label>
                            <select class="form-select" id="modal_year_level" name="year_level" onchange="checkBESModal()">
                                <option value="">Select Year</option>
                            </select>
                        </div>
                        <div class="col-md-4" id="modal_prog_col">
                            <label class="form-label text-muted small fw-bold">Program / Course</label>
                            <select class="form-select" id="modal_program" name="program" onchange="checkModalMajors()">
                                <option value="">Select Department First</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3 d-none" id="modal_major_container">
                        <label class="form-label text-muted small fw-bold" id="modal_major_label">Major / Strand</label>
                        <select class="form-select" id="modal_major" name="major">
                            <option value="">Select Option</option>
                        </select>
                    </div>
                </form>

            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary rounded-pill px-4" style="background-color: var(--primary-green); border: none;" onclick="confirmSave()">
                    Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// 1. MASTER DATA
// Updated to match add_patron.html structure with Majors/Strands
const schoolData = {
    "SBS": [
        { name: "Bachelor of Science in Computer Science" },
        { name: "Bachelor of Science in Information Systems" },
        { name: "Bachelor of Science in Accountancy" },
        { name: "Bachelor of Science in Business Administration" },
        { name: "Bachelor of Science in Real Estate Management" }
    ],
    "SHES": [
        { name: "Bachelor of Science in Nursing" }
    ],
    "SEAS": [
        { name: "Bachelor of Arts in English" },
        { name: "Bachelor of Arts in History" },
        { name: "Bachelor of Arts in Political Science" },
        { name: "Bachelor of Early Childhood Education" },
        { name: "Bachelor of Elementary Education" },
        { name: "Bachelor of Secondary Education", majors: ["English", "Biological Science", "Filipino", "Mathematics", "Social Studies"] }
    ],
    "GS": [
        { name: "Master of Arts in Education", majors: ["Teacher Education", "Preschool Education"] },
        { name: "Master of Arts in Nursing", majors: ["Community Health", "Maternal and Child Care"] }
    ],
    "BES": [
        { name: "Nursery" },
        { name: "Kinder 1" },
        { name: "Kinder 2" },
        { name: "Grade 1" }, { name: "Grade 2" }, { name: "Grade 3" }, { name: "Grade 4" },
        { name: "Grade 5" }, { name: "Grade 6" }, { name: "Grade 7" }, { name: "Grade 8" },
        { name: "Grade 9" }, { name: "Grade 10" },
        { name: "Grade 11", majors: ["Academic Track: ABM", "Academic Track: GAS", "Academic Track: HUMSS", "Academic Track: STEM"] },
        { name: "Grade 12", majors: ["Academic Track: ABM", "Academic Track: GAS", "Academic Track: HUMSS", "Academic Track: STEM"] }
    ]
};

// 2. Function to update Program options based on Department
function updatePrograms() {
    const deptSelect = document.getElementById("deptSelect");
    const programSelect = document.getElementById("programSelect");
    const yearSelect = document.getElementById("yearLevelSelect");
    const selectedDept = deptSelect.value;

    programSelect.innerHTML = '<option value="">All Programs</option>';
    yearSelect.innerHTML = '<option value="">All Levels</option>';
    yearSelect.disabled = false;
    programSelect.disabled = false;

    if (selectedDept === "BES") {
        // BES Logic: Year Level gets Grades, Program gets Tracks (if G11/12)
        if (schoolData["BES"]) {
            schoolData["BES"].forEach(prog => {
                let option = document.createElement("option");
                option.value = prog.name;
                option.textContent = prog.name;
                if (prog.majors) {
                    option.setAttribute("data-majors", JSON.stringify(prog.majors));
                }
                yearSelect.appendChild(option);
            });
        }
        programSelect.disabled = true; // Disabled until Grade 11/12 is selected
    } else {
        // College Logic: Year Level gets 1st-4th, Program gets Courses
        const collegeYears = ["1st Year", "2nd Year", "3rd Year", "4th Year"];
        collegeYears.forEach(y => {
            let option = document.createElement("option");
            option.value = y;
            option.textContent = y;
            yearSelect.appendChild(option);
        });

        if (selectedDept && schoolData[selectedDept]) {
            schoolData[selectedDept].forEach(prog => {
                let option = document.createElement("option");
                option.value = prog.name;
                option.textContent = prog.name;
                programSelect.appendChild(option);
            });
        }
    }
}

function checkBESFilter() {
    const deptSelect = document.getElementById("deptSelect");
    if (deptSelect.value !== "BES") return;

    const yearSelect = document.getElementById("yearLevelSelect");
    const programSelect = document.getElementById("programSelect");
    const selectedOption = yearSelect.options[yearSelect.selectedIndex];
    const majorsData = selectedOption.getAttribute("data-majors");

    programSelect.innerHTML = '<option value="">All Tracks</option>';

    if (majorsData) {
        programSelect.disabled = false;
        const majors = JSON.parse(majorsData);
        majors.forEach(m => {
            let option = document.createElement("option");
            option.value = m;
            option.textContent = m;
            programSelect.appendChild(option);
        });
    } else {
        programSelect.disabled = true;
    }
}

function updateModalPrograms() {
    const deptSelect = document.getElementById("modal_department");
    const programSelect = document.getElementById("modal_program");
    const yearSelect = document.getElementById("modal_year_level");
    const majorContainer = document.getElementById("modal_major_container");
    const selectedDept = deptSelect.value;

    programSelect.innerHTML = '<option value="">Select Program</option>';
    yearSelect.innerHTML = '<option value="">Select Year</option>';
    majorContainer.classList.add("d-none");
    programSelect.disabled = false;

    if (selectedDept === "BES") {
        // BES Logic for Modal
        if (schoolData["BES"]) {
            schoolData["BES"].forEach(prog => {
                let option = document.createElement("option");
                option.value = prog.name;
                option.textContent = prog.name;
                if (prog.majors) {
                    option.setAttribute("data-majors", JSON.stringify(prog.majors));
                }
                yearSelect.appendChild(option);
            });
        }
        programSelect.disabled = true; // Wait for Grade 11/12 selection
    } else {
        // College Logic for Modal
        const collegeYears = ["1st Year", "2nd Year", "3rd Year", "4th Year"];
        collegeYears.forEach(y => {
            let option = document.createElement("option");
            option.value = y;
            option.textContent = y;
            yearSelect.appendChild(option);
        });

        if (selectedDept && schoolData[selectedDept]) {
            schoolData[selectedDept].forEach(prog => {
                const option = document.createElement("option");
                option.value = prog.name;
                option.textContent = prog.name;
                programSelect.appendChild(option);
            });
        }
    }
}

function checkBESModal() {
    const deptSelect = document.getElementById("modal_department");
    if (deptSelect.value !== "BES") return;

    const yearSelect = document.getElementById("modal_year_level");
    const programSelect = document.getElementById("modal_program");
    const selectedOption = yearSelect.options[yearSelect.selectedIndex];
    const majorsData = selectedOption.getAttribute("data-majors");

    programSelect.innerHTML = '<option value="">Select Track</option>';

    if (majorsData) {
        programSelect.disabled = false;
        const majors = JSON.parse(majorsData);
        majors.forEach(m => {
            let option = document.createElement("option");
            option.value = m;
            option.textContent = m;
            programSelect.appendChild(option);
        });
    } else {
        programSelect.disabled = true;
    }
}

function checkModalMajors() {
    const programSelect = document.getElementById("modal_program");
    const majorContainer = document.getElementById("modal_major_container");
    const majorSelect = document.getElementById("modal_major");
    const majorLabel = document.getElementById("modal_major_label");

    const selectedOption = programSelect.options[programSelect.selectedIndex];
    const majorsData = selectedOption.getAttribute("data-majors");

    majorSelect.innerHTML = '<option value="">Select Option</option>';

    if (majorsData) {
        const majors = JSON.parse(majorsData);
        majors.forEach(m => {
            let option = document.createElement("option");
            option.value = m;
            option.textContent = m;
            majorSelect.appendChild(option);
        });

        if (selectedOption.value.includes("Grade")) {
            majorLabel.textContent = "Track / Strand";
        } else {
            majorLabel.textContent = "Major / Specialization";
        }

        majorContainer.classList.remove("d-none");
        majorSelect.required = true;
    } else {
        majorContainer.classList.add("d-none");
        majorSelect.required = false;
    }
}

function toggleModalRole() {
    const role = document.getElementById("modal_role").value;
    
    const deptCol = document.getElementById("modal_dept_col");
    const progCol = document.getElementById("modal_prog_col");
    const yearCol = document.getElementById("modal_year_level_container");
    const majorContainer = document.getElementById("modal_major_container");
    
    const deptSelect = document.getElementById("modal_department");
    const progSelect = document.getElementById("modal_program");
    const yearSelect = document.getElementById("modal_year_level");
    const majorSelect = document.getElementById("modal_major");

    // Reset to Student State (Visible & Enabled)
    deptCol.classList.remove("d-none");
    progCol.classList.remove("d-none");
    // yearCol visibility is managed by updateModalPrograms
    
    deptSelect.disabled = false;
    progSelect.disabled = false;
    yearSelect.disabled = false;
    majorSelect.disabled = false;

    if (role === "faculty") {
        // Grey out (Disable) Program, Year, Major
        // AND clear their values to prevent old data from sticking
        progSelect.disabled = true;
        yearSelect.disabled = true;
        majorSelect.disabled = true;
        progSelect.value = "";
        yearSelect.value = "";
        majorSelect.value = "";
        majorContainer.classList.add("d-none");

    } else if (role === "guest") {
        // Remove (Hide & Disable) Dept, Prog, Year, Major
        // AND clear their values
        deptCol.classList.add("d-none");
        progCol.classList.add("d-none");
        yearCol.classList.add("d-none");
        majorContainer.classList.add("d-none");
        
        deptSelect.disabled = true;
        progSelect.disabled = true;
        yearSelect.disabled = true;
        majorSelect.disabled = true;

        deptSelect.value = "";
        progSelect.value = "";
        yearSelect.value = "";
        majorSelect.value = "";

    } else {
        // Student: Ensure logic runs to show/hide Year based on Dept
        updateModalPrograms();
        checkModalMajors();
    }
}

document.addEventListener("DOMContentLoaded", function() {
    updatePrograms();
    
    // Sticky Year Filter
    const currentYear = "{{ request.GET.year_level|default_if_none:''|escapejs }}";
    if (currentYear) {
        document.getElementById("yearLevelSelect").value = currentYear;
        checkBESFilter(); // Trigger track population for BES if Grade 11/12 is selected
    }

    // Sticky Program Filter (Must run AFTER checkBESFilter populates options)
    const currentProgram = "{{ request.GET.program|default_if_none:''|escapejs }}";
    if (currentProgram) {
        document.getElementById("programSelect").value = currentProgram;
    }
});

function openEditModal(button) {
    // 1. Get data from button attributes
    const id = button.getAttribute('data-id');
    const first = button.getAttribute('data-firstname');
    const mid = button.getAttribute('data-middlename');
    const last = button.getAttribute('data-lastname');
    const email = button.getAttribute('data-email');
    const prog = button.getAttribute('data-program');
    const role = button.getAttribute('data-role');
    const dept = button.getAttribute('data-department');
    const year = button.getAttribute('data-yearlevel'); // NEW
    const major = button.getAttribute('data-major'); // NEW

    // 2. Set values in the modal inputs
    document.getElementById('modal_id_number').value = id;
    document.getElementById('modal_first_name').value = first;
    document.getElementById('modal_middle_name').value = mid;
    document.getElementById('modal_last_name').value = last;
    document.getElementById('modal_email').value = email;
    document.getElementById('modal_role').value = role;
    
    // Handle Department & Program Dropdowns
    document.getElementById('modal_department').value = dept;
    
    toggleModalRole(); // Apply role-based UI logic

    // --- INTELLIGENT DATA MAPPING FOR BES ---
    // If BES, we need to handle old data (where Grade was in Program) vs new UI (Grade in Year)
    if (dept === "BES") {
        // Check if the 'prog' variable looks like a Grade (Old Data)
        if (prog.includes("Grade") || prog.includes("Kinder") || prog.includes("Nursery")) {
            document.getElementById('modal_year_level').value = prog; // Put Grade into Year dropdown
            checkBESModal(); // Trigger track population
            document.getElementById('modal_program').value = major; // Put Track into Program dropdown
        } else {
            // New Data format
            document.getElementById('modal_year_level').value = year;
            checkBESModal();
            document.getElementById('modal_program').value = prog;
        }
    } else {
        // Standard College Logic
        document.getElementById('modal_program').value = prog;
        document.getElementById('modal_year_level').value = year;
    }
    
    checkModalMajors(); // Now check majors based on the set program
    document.getElementById('modal_major').value = major; 

    const form = document.getElementById('editForm');
    form.action = "/update-patron/" + id + "/";

    const myModal = new bootstrap.Modal(document.getElementById('editPatronModal'));
    myModal.show();
}

function confirmSave() {
    if (confirm("Are you sure you want to save these changes?")) {
        document.getElementById('editForm').submit();
    }
}

function confirmResend(idNumber, email) {
    if (!email) {
        alert("This user does not have an email address. Please edit the user to add one first.");
        return;
    }
    if (confirm("Are you sure you want to resend the QR code to " + email + "?")) {
        window.location.href = "/resend-qr/" + idNumber + "/";
    }
}

function confirmDelete(idNumber) {
    if (confirm("Are you sure you want to PERMANENTLY delete this user?")) {
        window.location.href = "/delete-patron/" + idNumber + "/";
    }
}
</script>
</body>
</html>