{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard | UCC Library</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-green: #0B3D2E;
            --light-bg: #f8f9fa;
            --text-dark: #343a40;
            --card-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        body {
            background-color: var(--light-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-dark);
            overflow-x: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            background-color: #0B3D2E;
            height: 100vh; color: white; box-shadow: 4px 0 10px rgba(0,0,0,0.1);
            position: fixed; top: 0; bottom: 0; left: 0; z-index: 100;
            width: 250px; overflow-y: auto; display: flex; flex-direction: column;
        }
        .sidebar::-webkit-scrollbar { width: 6px; }
        .sidebar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
        .nav-link {
            color: rgba(255,255,255,0.85); margin-bottom: 8px; padding: 12px 15px; border-radius: 8px;
            transition: all 0.3s ease; font-size: 0.95rem; white-space: nowrap;
        }
        .nav-link:hover { color: white; background: rgba(255,255,255,0.15); transform: translateX(5px); }
        .nav-link.active { background-color: white; color: #0B3D2E; font-weight: 700; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .sidebar-logo { max-width: 80px; margin-bottom: 15px; border: 3px solid rgba(255,255,255,0.2); border-radius: 50%; padding: 5px; }

        /* MAIN CONTENT */
        .main-content { margin-left: 250px; padding: 50px 30px 30px 30px; width: calc(100% - 250px); }

        @media (max-width: 768px) {
            .sidebar { width: 80px; align-items: center; }
            .sidebar .nav-link span, .sidebar .sidebar-heading { display: none; }
            .sidebar-logo { width: 40px; }
            .main-content { margin-left: 80px; width: calc(100% - 80px); }
        }

        /* CARDS */
        .stat-card { border: none; border-radius: 20px; background: white; box-shadow: var(--card-shadow); transition: transform 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); }
        .icon-box { width: 60px; height: 60px; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 1.75rem; }

        .content-card { background: white; border-radius: 20px; border: none; box-shadow: var(--card-shadow); height: 100%; display: flex; flex-direction: column; overflow: hidden; }
        .card-header-custom { padding: 20px 25px; border-bottom: 1px solid #eee; background: white; }
        .section-title { font-size: 1.1rem; font-weight: 700; color: var(--primary-green); margin: 0; text-transform: uppercase; }

        /* TABLES */
        .table thead th { background: #f8f9fa; color: #6c757d; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; padding: 12px 15px; border: none; }
        .table tbody td { padding: 10px 15px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; font-size: 0.9rem; }
        .badge-custom { padding: 5px 10px; border-radius: 50px; font-weight: 600; font-size: 0.7rem; }

        /* PREVENT TEXT WRAPPING */
        .no-wrap-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .compact-col { width: 1%; white-space: nowrap; } /* Forces column to be as small as content */
    </style>
</head>
<body>

<div class="container-fluid p-0">

    <div class="sidebar p-3">
        <div class="text-center mb-4 mt-2">
            <img src="{% static 'ucc_logo.png' %}" alt="Logo" class="sidebar-logo">
            <h5 class="fw-bold m-0 sidebar-heading" style="font-size: 1rem; letter-spacing: 1px;">UCC LIBRARY</h5>
            <small class="text-white-50">Attendance System</small>
        </div>

        <nav class="nav flex-column flex-grow-1">
            <div class="text-white-50 text-uppercase px-3 small fw-bold mb-2 sidebar-heading" style="font-size: 0.75rem;">Core Menu</div>
            <a class="nav-link" href="{% url 'dashboard' %}"><i class="fas fa-chart-pie me-3"></i> <span>Dashboard</span></a>
            <a class="nav-link" href="{% url 'landing_page' %}"><i class="fas fa-qrcode me-3"></i> <span>Scanner Mode</span></a>
            <a class="nav-link" href="{% url 'manual_checkin' %}"><i class="fas fa-keyboard me-3"></i> <span>Manual Entry</span></a>

            <div class="text-white-50 text-uppercase px-3 small fw-bold mt-4 mb-2 sidebar-heading" style="font-size: 0.75rem;">Management</div>
            <a class="nav-link active" href="{% url 'patron_list' %}"><i class="fas fa-users me-3"></i> <span>User List</span></a>
            <a class="nav-link" href="{% url 'add_patron' %}"><i class="fas fa-user-plus me-3"></i> <span>Register User</span></a>
            <a class="nav-link" href="{% url 'bulk_import' %}"><i class="fas fa-file-csv me-3"></i> <span>Bulk Import</span></a>

            <div class="text-white-50 text-uppercase px-3 small fw-bold mt-4 mb-2 sidebar-heading" style="font-size: 0.75rem;">Reports</div>
            <a class="nav-link" href="{% url 'report_selection' %}"><i class="fas fa-file-alt me-3"></i> <span>Print Reports</span></a>
            <a class="nav-link" href="{% url 'scan_history' %}"><i class="fas fa-history me-3"></i> <span>History Logs</span></a>
        </nav>

        <div class="mt-4 pb-4 border-top border-secondary pt-3">
            <a class="nav-link text-danger fw-bold" href="{% url 'logout' %}"><i class="fas fa-sign-out-alt me-3"></i> <span>Logout</span></a>
            <div class="text-center mt-3">
                <small class="text-white-50 d-block" style="font-size: 0.65rem; letter-spacing: 1px; opacity: 0.7;">CREATED BY JESICS</small>
                <small class="text-white-50 d-block" style="font-size: 0.65rem; letter-spacing: 1px; opacity: 0.7;">ALL RIGHTS RESERVED 2026</small>
            </div>
        </div>
    </div>

    <div class="main-content">
        <h2 class="fw-bold text-dark mb-4">Registered Users List</h2>

        <div class="card p-4 mb-4 border-0 shadow-sm rounded-4">
            <form method="get" class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label small fw-bold text-muted">Search</label>
                        <input type="text" name="q" class="form-control" placeholder="Name or ID..." value="{{ request.GET.q }}">
                    </div>

                    <div class="col-md-3">
                        <label class="form-label small fw-bold text-muted">Department</label>
                        <select name="department" id="deptSelect" class="form-select" onchange="updatePrograms()">
                            <option value="">All Departments</option>
                            {% for code, name in departments %}
                                <option value="{{ code }}" {% if request.GET.department == code %}selected{% endif %}>{{ name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label small fw-bold text-muted">Program</label>
                        <select name="program" id="programSelect" class="form-select">
                            <option value="">All Programs</option>
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label small fw-bold text-muted">Year Level</label>
                        <select name="year_level" class="form-select">
                            <option value="">All Levels</option>
                            <option value="1st Year" {% if request.GET.year_level == "1st Year" %}selected{% endif %}>1st Year</option>
                            <option value="2nd Year" {% if request.GET.year_level == "2nd Year" %}selected{% endif %}>2nd Year</option>
                            <option value="3rd Year" {% if request.GET.year_level == "3rd Year" %}selected{% endif %}>3rd Year</option>
                            <option value="4th Year" {% if request.GET.year_level == "4th Year" %}selected{% endif %}>4th Year</option>
                            <option value="Grade 11" {% if request.GET.year_level == "Grade 11" %}selected{% endif %}>Grade 11</option>
                            <option value="Grade 12" {% if request.GET.year_level == "Grade 12" %}selected{% endif %}>Grade 12</option>
                        </select>
                    </div>

                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100 fw-bold" style="background-color: var(--primary-green); border: none;">
                            <i class="fas fa-filter me-2"></i> Apply
                        </button>
                    </div>
                </form>
        </div>

        <div class="card shadow-sm border-0 rounded-4">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th class="p-3">ID Number</th>
                                <th>Name</th>
                                <th>Role</th>
                                <th>Department</th>
                                <th>Year Level</th> <th>Last Time In</th>
                                <th>Last Time Out</th>
                                <th class="text-center p-3">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for patron in patrons %}
                            <tr>
                                <td class="p-3 fw-bold">{{ patron.id_number }}</td>
                                <td>
                                    {{ patron.first_name }} {% if patron.middle_name %}{{ patron.middle_name|slice:":1" }}.{% endif %} {{ patron.last_name }}
                                    {% if patron.program %}
                                        <br><small class="text-muted">{{ patron.program }}</small>
                                    {% endif %}
                                </td>
                                <td><span class="badge bg-secondary rounded-pill">{{ patron.get_role_display }}</span></td>

                                <td>{{ patron.get_department_display|default:"-" }}</td>

                                <td>{{ patron.year_level|default:"-" }}</td>

                                {% with last_log=patron.logs.first %}
                                <td>
                                    {% if last_log %}
                                        {{ last_log.scan_time|date:"h:i A" }}
                                        <div class="small text-muted">{{ last_log.scan_time|date:"M d" }}</div>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if last_log %}
                                        {% if last_log.time_out %}
                                            {{ last_log.time_out|date:"h:i A" }}
                                            <div class="small text-muted">{{ last_log.time_out|date:"M d" }}</div>
                                        {% else %}
                                            <span class="badge bg-success rounded-pill px-3 py-2">Active</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                {% endwith %}

                                <td class="text-center p-3">
                                    <div class="d-flex justify-content-center gap-2">
                                        <a href="{% url 'patron_detail' patron.id_number %}" class="btn btn-sm btn-outline-dark rounded-pill px-3" title="View QR Code">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button type="button"
                                            class="btn btn-sm btn-outline-primary rounded-pill px-3"
                                            data-id="{{ patron.id_number }}"
                                            data-firstname="{{ patron.first_name }}"
                                            data-middlename="{{ patron.middle_name }}"
                                            data-lastname="{{ patron.last_name }}"
                                            data-program="{{ patron.program }}"
                                            data-role="{{ patron.role }}"
                                            data-department="{{ patron.department }}"
                                            data-yearlevel="{{ patron.year_level }}"
                                            onclick="openEditModal(this)"
                                            title="Edit">
                                            <i class="fas fa-pen"></i>
                                        </button>
                                        <button type="button"
                                            class="btn btn-sm btn-outline-danger rounded-pill px-3"
                                            onclick="confirmDelete('{{ patron.id_number }}')"
                                            title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="8" class="text-center py-5 text-muted">No users found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="editPatronModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content rounded-4 border-0 shadow">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold">Edit User Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">

                <form id="editForm" method="post" action="">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">ID Number</label>
                        <input type="text" class="form-control" id="modal_id_number" name="id_number" readonly>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-md-4">
                            <label class="form-label text-muted small fw-bold">First Name</label>
                            <input type="text" class="form-control" id="modal_first_name" name="first_name">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-muted small fw-bold">Middle Name</label>
                            <input type="text" class="form-control" id="modal_middle_name" name="middle_name">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-muted small fw-bold">Last Name</label>
                            <input type="text" class="form-control" id="modal_last_name" name="last_name">
                        </div>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-md-4">
                            <label class="form-label text-muted small fw-bold">Program / Course</label>
                            <input type="text" class="form-control" id="modal_program" name="program">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-muted small fw-bold">Department</label>
                            <select class="form-select" id="modal_department" name="department">
                                {% for code, name in departments %}
                                    <option value="{{ code }}">{{ name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-muted small fw-bold">Year Level</label>
                            <input type="text" class="form-control" id="modal_year_level" name="year_level" placeholder="e.g. 1st Year">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">Role</label>
                        <select class="form-select" id="modal_role" name="role">
                            <option value="student">Student</option>
                            <option value="faculty">Faculty</option>
                            <option value="guest">Guest</option>
                        </select>
                    </div>
                </form>

            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary rounded-pill px-4" style="background-color: var(--primary-green); border: none;" onclick="confirmSave()">
                    Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// 1. MASTER DATA
const schoolData = {
    "SBS": [
        "Bachelor of Science in Computer Science",
        "Bachelor of Science in Information Systems",
        "Bachelor of Science in Accountancy",
        "Bachelor of Science in Business Administration",
        "Bachelor of Science in Real Estate Management"
    ],
    "SHES": [ "Bachelor of Science in Nursing" ],
    "SEAS": [
        "Bachelor of Arts in English",
        "Bachelor of Arts in History",
        "Bachelor of Arts in Political Science",
        "Bachelor of Early Childhood Education",
        "Bachelor of Elementary Education",
        "Bachelor of Secondary Education"
    ],
    "GS": [ "Master of Arts in Education", "Master of Arts in Nursing" ],
    "BES": [
        "Nursery", "Kinder 1", "Kinder 2",
        "Grade 1", "Grade 2", "Grade 3", "Grade 4",
        "Grade 5", "Grade 6", "Grade 7", "Grade 8",
        "Grade 9", "Grade 10", "Grade 11", "Grade 12"
    ]
};

// 2. Function to update Program options based on Department
function updatePrograms() {
    const deptSelect = document.getElementById("deptSelect");
    const programSelect = document.getElementById("programSelect");
    const selectedDept = deptSelect.value;

    programSelect.innerHTML = '<option value="">All Programs</option>';

    if (selectedDept && schoolData[selectedDept]) {
        schoolData[selectedDept].forEach(progName => {
            const option = document.createElement("option");
            option.value = progName;
            option.textContent = progName;
            programSelect.appendChild(option);
        });
    }
}

document.addEventListener("DOMContentLoaded", function() {
    updatePrograms();
    // Sticky Program Filter
    const currentProgram = "{{ request.GET.program|default_if_none:''|escapejs }}";
    if (currentProgram) {
        document.getElementById("programSelect").value = currentProgram;
    }
});

function openEditModal(button) {
    // 1. Get data from button attributes
    const id = button.getAttribute('data-id');
    const first = button.getAttribute('data-firstname');
    const mid = button.getAttribute('data-middlename');
    const last = button.getAttribute('data-lastname');
    const prog = button.getAttribute('data-program');
    const role = button.getAttribute('data-role');
    const dept = button.getAttribute('data-department');
    const year = button.getAttribute('data-yearlevel'); // NEW

    // 2. Set values in the modal inputs
    document.getElementById('modal_id_number').value = id;
    document.getElementById('modal_first_name').value = first;
    document.getElementById('modal_middle_name').value = mid;
    document.getElementById('modal_last_name').value = last;
    document.getElementById('modal_program').value = prog;
    document.getElementById('modal_role').value = role;
    document.getElementById('modal_department').value = dept;
    document.getElementById('modal_year_level').value = year; // NEW

    const form = document.getElementById('editForm');
    form.action = "/update-patron/" + id + "/";

    const myModal = new bootstrap.Modal(document.getElementById('editPatronModal'));
    myModal.show();
}

function confirmSave() {
    if (confirm("Are you sure you want to save these changes?")) {
        document.getElementById('editForm').submit();
    }
}

function confirmDelete(idNumber) {
    if (confirm("Are you sure you want to PERMANENTLY delete this user?")) {
        window.location.href = "/delete-patron/" + idNumber + "/";
    }
}
</script>
</body>
</html>